name: Validate Tools JSON

on: 
  pull_request_target:
    paths:
    - '_data/tools.json'
    - 'tools_schema.json'
  # Allow manual workflow runs for testing validation scripts
  workflow_dispatch:


jobs:
  schema-check:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha || github.sha }}
        repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
    - name: Save PR number
      if: github.event_name == 'pull_request_target'
      env:
        PR_NUMBER: ${{ github.event.number }}
      run: echo $PR_NUMBER > pr_number
    - name: Run schema check
      id: schema
      continue-on-error: true
      run: |
        python3 .github/workflows/scripts/check_schema.py tools_schema.json _data/tools.json > schema_log.txt 2>&1
    - name: Run alphabetical ordering check
      id: ordering
      continue-on-error: true
      run: |
        python3 .github/workflows/scripts/check_ordering.py _data/tools.json > ordering_log.txt 2>&1
    - name: Run duplicate detection check
      id: duplicates
      continue-on-error: true
      run: |
        python3 .github/workflows/scripts/check_duplicates.py _data/tools.json > duplicates_log.txt 2>&1
    - name: Run .editorconfig compliance check
      id: editorconfig
      continue-on-error: true
      run: |
        python3 .github/workflows/scripts/check_editorconfig.py _data/tools.json > editorconfig_log.txt 2>&1
    - name: Create unified artifact and summary
      if: always()
      run: |
        # Initialize summary (shows all results)
        echo "# Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Initialize overall status
        overall_status=0
        
        # Initialize artifact file with header (only failures will be added)
        echo "**The following issues were identified:**" > artifact.txt
        echo "" >> artifact.txt
        
        # Schema validation results
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "## Schema Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.schema.outcome }}" == "success" ]; then
          echo "**Status: PASS ✓**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All entries conform to the schema." >> $GITHUB_STEP_SUMMARY
        else
          echo "**Status: FAIL ✗**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat schema_log.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          # Add to artifact (for PR comment)
          echo "## Schema Validation" >> artifact.txt
          echo "" >> artifact.txt
          cat schema_log.txt >> artifact.txt
          echo "" >> artifact.txt
          overall_status=1
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Alphabetical ordering results
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "## Alphabetical Ordering Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.ordering.outcome }}" == "success" ]; then
          echo "**Status: PASS ✓**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat ordering_log.txt >> $GITHUB_STEP_SUMMARY
        else
          echo "**Status: FAIL ✗**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat ordering_log.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          # Add to artifact (for PR comment)
          echo "## Alphabetical Ordering Check" >> artifact.txt
          echo "" >> artifact.txt
          cat ordering_log.txt >> artifact.txt
          echo "" >> artifact.txt
          overall_status=1
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Duplicate detection results
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "## Duplicate Detection Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.duplicates.outcome }}" == "success" ]; then
          echo "**Status: PASS ✓**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat duplicates_log.txt >> $GITHUB_STEP_SUMMARY
        else
          echo "**Status: FAIL ✗**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat duplicates_log.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          # Add to artifact (for PR comment)
          echo "## Duplicate Detection Check" >> artifact.txt
          echo "" >> artifact.txt
          cat duplicates_log.txt >> artifact.txt
          echo "" >> artifact.txt
          overall_status=1
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # .editorconfig compliance results
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "## .editorconfig Compliance Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.editorconfig.outcome }}" == "success" ]; then
          echo "**Status: PASS ✓**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat editorconfig_log.txt >> $GITHUB_STEP_SUMMARY
        else
          echo "**Status: FAIL ✗**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat editorconfig_log.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          # Add to artifact (for PR comment)
          echo "## .editorconfig Compliance Check" >> artifact.txt
          echo "" >> artifact.txt
          cat editorconfig_log.txt >> artifact.txt
          echo "" >> artifact.txt
          overall_status=1
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        
        # Exit with error if any check failed
        exit $overall_status
    - name: Upload validation results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: artifact
        path: |
          artifact.txt
          pr_number
